import{K as se,d as N,L as I,h as o,M as ue,u as H,O as de,c as L,j as ce,P as q,Q as pe,F as b,N as ve,b as D,R as U,a as V,S as fe,U as me,g as G,V as he,s as P,X as F,Y as ge,Z as ke,k as O,o as S,l as g,$ as we,q as xe,r as ye,t as be,v as n,w as a,x as l,B as _,E as y,G as Ce,D as T,H as M,z as _e,A as Pe,W as Ne,C as B,_ as Te}from"./index-BXrhl0aj.js";import{u as ze,N as Se}from"./Divider-uLh5BIAi.js";import{u as Oe,N as je,a as z,b as E,c as Be}from"./Switch-B0ZxsExE.js";import{N as Me,S as Re}from"./SearchOutline-DO6iKWTm.js";import{u as W,W as Le,o as Ue,N as $e,b as Ie,d as j,e as qe,a as R,R as De}from"./RefreshOutline-DrsxFm1q.js";import{F as A}from"./FlashOutline-CkFrgqm2.js";import{N as Ve}from"./DataTable-HTkUYJTf.js";const Q=se("n-popconfirm"),X={positiveText:String,negativeText:String,showIcon:{type:Boolean,default:!0},onPositiveClick:{type:Function,required:!0},onNegativeClick:{type:Function,required:!0}},K=pe(X),Fe=N({name:"NPopconfirmPanel",props:X,setup(d){const{localeRef:i}=W("Popconfirm"),{inlineThemeDisabled:r}=H(),{mergedClsPrefixRef:v,mergedThemeRef:k,props:m}=de(Q),C=L(()=>{const{common:{cubicBezierEaseInOut:c},self:{fontSize:f,iconSize:h,iconColor:w}}=k.value;return{"--n-bezier":c,"--n-font-size":f,"--n-icon-size":h,"--n-icon-color":w}}),p=r?ce("popconfirm-panel",void 0,C,m):void 0;return Object.assign(Object.assign({},W("Popconfirm")),{mergedClsPrefix:v,cssVars:r?void 0:C,localizedPositiveText:L(()=>d.positiveText||i.value.positiveText),localizedNegativeText:L(()=>d.negativeText||i.value.negativeText),positiveButtonProps:q(m,"positiveButtonProps"),negativeButtonProps:q(m,"negativeButtonProps"),handlePositiveClick(c){d.onPositiveClick(c)},handleNegativeClick(c){d.onNegativeClick(c)},themeClass:p?.themeClass,onRender:p?.onRender})},render(){var d;const{mergedClsPrefix:i,showIcon:r,$slots:v}=this,k=I(v.action,()=>this.negativeText===null&&this.positiveText===null?[]:[this.negativeText!==null&&o(b,Object.assign({size:"small",onClick:this.handleNegativeClick},this.negativeButtonProps),{default:()=>this.localizedNegativeText}),this.positiveText!==null&&o(b,Object.assign({size:"small",type:"primary",onClick:this.handlePositiveClick},this.positiveButtonProps),{default:()=>this.localizedPositiveText})]);return(d=this.onRender)===null||d===void 0||d.call(this),o("div",{class:[`${i}-popconfirm__panel`,this.themeClass],style:this.cssVars},ue(v.default,m=>r||m?o("div",{class:`${i}-popconfirm__body`},r?o("div",{class:`${i}-popconfirm__icon`},I(v.icon,()=>[o(ve,{clsPrefix:i},{default:()=>o(Le,null)})])):null,m):null),k?o("div",{class:[`${i}-popconfirm__action`]},k):null)}}),Ee=D("popconfirm",[U("body",`
 font-size: var(--n-font-size);
 display: flex;
 align-items: center;
 flex-wrap: nowrap;
 position: relative;
 `,[U("icon",`
 display: flex;
 font-size: var(--n-icon-size);
 color: var(--n-icon-color);
 transition: color .3s var(--n-bezier);
 margin: 0 8px 0 0;
 `)]),U("action",`
 display: flex;
 justify-content: flex-end;
 `,[V("&:not(:first-child)","margin-top: 8px"),D("button",[V("&:not(:last-child)","margin-right: 8px;")])])]),We=Object.assign(Object.assign(Object.assign({},G.props),ge),{positiveText:String,negativeText:String,showIcon:{type:Boolean,default:!0},trigger:{type:String,default:"click"},positiveButtonProps:Object,negativeButtonProps:Object,onPositiveClick:Function,onNegativeClick:Function}),Ae=N({name:"Popconfirm",props:We,slots:Object,__popover__:!0,setup(d){const{mergedClsPrefixRef:i}=H(),r=G("Popconfirm","-popconfirm",Ee,he,d,i),v=P(null);function k(p){var c;if(!(!((c=v.value)===null||c===void 0)&&c.getMergedShow()))return;const{onPositiveClick:f,"onUpdate:show":h}=d;Promise.resolve(f?f(p):!0).then(w=>{var x;w!==!1&&((x=v.value)===null||x===void 0||x.setShow(!1),h&&F(h,!1))})}function m(p){var c;if(!(!((c=v.value)===null||c===void 0)&&c.getMergedShow()))return;const{onNegativeClick:f,"onUpdate:show":h}=d;Promise.resolve(f?f(p):!0).then(w=>{var x;w!==!1&&((x=v.value)===null||x===void 0||x.setShow(!1),h&&F(h,!1))})}return ke(Q,{mergedThemeRef:r,mergedClsPrefixRef:i,props:d}),{setShow(p){var c;(c=v.value)===null||c===void 0||c.setShow(p)},syncPosition(){var p;(p=v.value)===null||p===void 0||p.syncPosition()},mergedTheme:r,popoverInstRef:v,handlePositiveClick:k,handleNegativeClick:m}},render(){const{$slots:d,$props:i,mergedTheme:r}=this;return o(fe,Object.assign({},Ue(i,K),{theme:r.peers.Popover,themeOverrides:r.peerOverrides.Popover,internalExtraClass:["popconfirm"],ref:"popoverInstRef"}),{trigger:d.trigger,default:()=>{const v=me(i,K);return o(Fe,Object.assign({},v,{onPositiveClick:this.handlePositiveClick,onNegativeClick:this.handleNegativeClick}),d)}})}}),Ke={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},He=N({name:"AddOutline",render:function(i,r){return S(),O("svg",Ke,r[0]||(r[0]=[g("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M256 112v288"},null,-1),g("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M400 256H112"},null,-1)]))}}),Ge={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Qe=N({name:"CreateOutline",render:function(i,r){return S(),O("svg",Ge,r[0]||(r[0]=[g("path",{d:"M384 224v184a40 40 0 0 1-40 40H104a40 40 0 0 1-40-40V168a40 40 0 0 1 40-40h167.48",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32"},null,-1),g("path",{d:"M459.94 53.25a16.06 16.06 0 0 0-23.22-.56L424.35 65a8 8 0 0 0 0 11.31l11.34 11.32a8 8 0 0 0 11.34 0l12.06-12c6.1-6.09 6.67-16.01.85-22.38z",fill:"currentColor"},null,-1),g("path",{d:"M399.34 90L218.82 270.2a9 9 0 0 0-2.31 3.93L208.16 299a3.91 3.91 0 0 0 4.86 4.86l24.85-8.35a9 9 0 0 0 3.93-2.31L422 112.66a9 9 0 0 0 0-12.66l-9.95-10a9 9 0 0 0-12.71 0z",fill:"currentColor"},null,-1)]))}}),Xe={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Ye=N({name:"LinkOutline",render:function(i,r){return S(),O("svg",Xe,r[0]||(r[0]=[g("path",{d:"M208 352h-64a96 96 0 0 1 0-192h64",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"36"},null,-1),g("path",{d:"M304 160h64a96 96 0 0 1 0 192h-64",fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"36"},null,-1),g("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"36",d:"M163.29 256h187.42"},null,-1)]))}}),Ze={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},Je=N({name:"PauseOutline",render:function(i,r){return S(),O("svg",Ze,r[0]||(r[0]=[g("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M176 96h16v320h-16z"},null,-1),g("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M320 96h16v320h-16z"},null,-1)]))}}),et={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},tt=N({name:"PlayOutline",render:function(i,r){return S(),O("svg",et,r[0]||(r[0]=[g("path",{d:"M112 111v290c0 17.44 17 28.52 31 20.16l247.9-148.37c12.12-7.25 12.12-26.33 0-33.58L143 90.84c-14-8.36-31 2.72-31 20.16z",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1)]))}}),lt={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},nt=N({name:"TrashOutline",render:function(i,r){return S(),O("svg",lt,r[0]||(r[0]=[we('<path d="M112 112l20 320c.95 18.49 14.4 32 32 32h184c17.67 0 30.87-13.51 32-32l20-320" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></path><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="32" d="M80 112h352" fill="currentColor"></path><path d="M192 112V72h0a23.93 23.93 0 0 1 24-24h80a23.93 23.93 0 0 1 24 24h0v40" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M256 176v224"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M184 176l8 224"></path><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="32" d="M328 176l-8 224"></path>',6)]))}}),rt={class:"tasks-page"},ot="留空使用系统默认提示词。支持占位符: {task_name}, {url}, {description}, {changes}",at=N({__name:"Tasks",setup(d){const i=ze();Oe();const r=xe(),v=ye(),k=P(!0),m=P(""),C=P("all"),p=[{label:"全部状态",value:"all"},{label:"已启用",value:"enabled"},{label:"已禁用",value:"disabled"},{label:"有错误",value:"error"}],c=L(()=>{let e=[...r.tasks];if(m.value){const t=m.value.toLowerCase();e=e.filter(u=>u.name.toLowerCase().includes(t)||u.url.toLowerCase().includes(t)||u.description.toLowerCase().includes(t))}if(C.value&&C.value!=="all")switch(C.value){case"enabled":e=e.filter(t=>t.enabled);break;case"disabled":e=e.filter(t=>!t.enabled);break;case"error":e=e.filter(t=>t.error_count>0);break}return e}),f=P(!1),h=P("add"),w=P(null),x=P(null),s=P({url:"",name:"",description:"",selectors:"",interval:300,timeout:3e4,enabled:!0,ai_prompt:""}),Y={url:[{required:!0,message:"请输入网页URL",trigger:"blur"},{validator:(e,t)=>t&&!t.startsWith("http://")&&!t.startsWith("https://")?new Error("URL必须以 http:// 或 https:// 开头"):!0,trigger:"blur"}],name:[{required:!0,message:"请输入任务名称",trigger:"blur"},{min:1,max:100,message:"任务名称长度应在1-100之间",trigger:"blur"}],interval:[{required:!0,type:"number",message:"请输入检测间隔",trigger:"blur"}],timeout:[{required:!0,type:"number",message:"请输入超时时间",trigger:"blur"}]},Z=e=>{if(!e)return"-";try{return new Date(e).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return e}},J=e=>e<60?`${e}秒`:e<3600?`${Math.floor(e/60)}分钟`:`${Math.floor(e/3600)}小时`,ee=[{title:"任务名称",key:"name",width:180,ellipsis:{tooltip:!0},render:e=>o(_,{align:"center"},{default:()=>[o("span",{style:{fontWeight:500}},e.name),e.error_count>0&&o(B,{},{trigger:()=>o(y,{color:"#e88080",size:16},{default:()=>o(A)}),default:()=>e.last_error_message||"任务存在错误"})]})},{title:"URL",key:"url",width:250,ellipsis:{tooltip:!0},render:e=>o(_,{align:"center"},{default:()=>[o(y,{size:14,color:"#63e2b7"},{default:()=>o(Ye)}),o("span",{style:{fontSize:"13px"}},e.url)]})},{title:"状态",key:"status",width:90,render:e=>e.enabled?e.error_count>0?o(R,{type:"error",size:"small"},{default:()=>"错误"}):o(R,{type:"success",size:"small"},{default:()=>"正常"}):o(R,{type:"default",size:"small"},{default:()=>"已禁用"})},{title:"检测间隔",key:"interval",width:100,render:e=>J(e.interval)},{title:"最后检测",key:"last_check",width:120,render:e=>Z(e.last_check)},{title:"变化次数",key:"change_count",width:90,align:"center"},{title:"操作",key:"actions",width:200,fixed:"right",render:e=>o(_,{size:"small"},{default:()=>[o(B,{},{trigger:()=>o(b,{size:"small",quaternary:!0,type:e.enabled?"warning":"success",onClick:()=>oe(e)},{icon:()=>o(y,{},{default:()=>o(e.enabled?Je:tt)})}),default:()=>e.enabled?"禁用":"启用"}),o(B,{},{trigger:()=>o(b,{size:"small",quaternary:!0,type:"info",onClick:()=>ae(e)},{icon:()=>o(y,{},{default:()=>o(A)})}),default:()=>"立即检测"}),o(B,{},{trigger:()=>o(b,{size:"small",quaternary:!0,type:"primary",onClick:()=>ne(e)},{icon:()=>o(y,{},{default:()=>o(Qe)})}),default:()=>"编辑"}),o(Ae,{onPositiveClick:()=>ie(e)},{trigger:()=>o(b,{size:"small",quaternary:!0,type:"error"},{icon:()=>o(y,{},{default:()=>o(nt)})}),default:()=>`确定要删除任务 "${e.name}" 吗？`})]})}],$=async()=>{k.value=!0;try{await r.fetchTasks()}finally{k.value=!1}},te=async()=>{await $(),i.success("刷新成功")},le=()=>{h.value="add",w.value=null,s.value={url:"",name:"",description:"",selectors:"",interval:300,timeout:3e4,enabled:!0,ai_prompt:""},f.value=!0},ne=e=>{h.value="edit",w.value=e,s.value={url:e.url,name:e.name,description:e.description,selectors:e.selectors.join(", "),interval:e.interval,timeout:e.timeout,enabled:e.enabled,ai_prompt:e.ai_prompt},f.value=!0},re=async()=>{try{await x.value?.validate()}catch{return}const e={url:s.value.url,name:s.value.name,description:s.value.description,selectors:s.value.selectors?s.value.selectors.split(",").map(t=>t.trim()).filter(Boolean):[],interval:s.value.interval,timeout:s.value.timeout,enabled:s.value.enabled,ai_prompt:s.value.ai_prompt};h.value==="add"?await r.createTask(e)?(i.success("任务创建成功"),f.value=!1):i.error("任务创建失败"):w.value&&(await r.updateTask(w.value.id,e)?(i.success("任务更新成功"),f.value=!1):i.error("任务更新失败"))},oe=async e=>{(e.enabled?await r.disableTask(e.id):await r.enableTask(e.id))?i.success(e.enabled?"已禁用":"已启用"):i.error("操作失败")},ae=async e=>{i.info(`正在检测 "${e.name}"...`);const t=await r.checkTask(e.id);t?t.error?i.error(`检测失败: ${t.error}`):t.changed?i.success("检测到变化！"):i.info("未检测到变化"):i.error("检测请求失败")},ie=async e=>{await r.deleteTask(e.id)?i.success("删除成功"):i.error("删除失败")};return be(async()=>{await $()}),(e,t)=>(S(),O("div",rt,[n(l($e),{show:k.value},{default:a(()=>[n(l(Ie),null,{header:a(()=>[n(l(_),{justify:"space-between",align:"center",style:{width:"100%"}},{default:a(()=>[n(l(_),{align:"center"},{default:a(()=>[t[14]||(t[14]=g("span",{class:"page-title"},"任务管理",-1)),l(v).isConnected?(S(),_e(l(B),{key:0,trigger:"hover"},{trigger:a(()=>[n(l(R),{type:"success",size:"small",round:""},{icon:a(()=>[n(l(y),null,{default:a(()=>[n(l(Ne))]),_:1})]),default:a(()=>[t[12]||(t[12]=T(" 实时更新 ",-1))]),_:1})]),default:a(()=>[t[13]||(t[13]=g("span",null,"任务状态将自动同步更新",-1))]),_:1})):Pe("",!0)]),_:1}),n(l(_),null,{default:a(()=>[n(l(b),{type:"primary",onClick:le},{icon:a(()=>[n(l(y),null,{default:a(()=>[n(l(He))]),_:1})]),default:a(()=>[t[15]||(t[15]=T(" 添加任务 ",-1))]),_:1}),n(l(b),{quaternary:"",circle:"",onClick:te},{icon:a(()=>[n(l(y),null,{default:a(()=>[n(l(De))]),_:1})]),_:1})]),_:1})]),_:1})]),default:a(()=>[n(l(_),{style:{"margin-bottom":"16px"}},{default:a(()=>[n(l(j),{value:m.value,"onUpdate:value":t[0]||(t[0]=u=>m.value=u),placeholder:"搜索任务名称、URL或描述",clearable:"",style:{width:"300px"}},{prefix:a(()=>[n(l(y),null,{default:a(()=>[n(l(Re))]),_:1})]),_:1},8,["value"]),n(l(qe),{value:C.value,"onUpdate:value":t[1]||(t[1]=u=>C.value=u),options:p,style:{width:"150px"},placeholder:"状态筛选"},null,8,["value"])]),_:1}),n(l(Ve),{columns:ee,data:c.value,bordered:!1,"single-line":!1,"row-key":u=>u.id,"scroll-x":1100,"max-height":"calc(100vh - 320px)"},null,8,["data","row-key"]),n(l(_),{style:{"margin-top":"16px"}},{default:a(()=>[n(l(Ce),{depth:"3"},{default:a(()=>[T(" 共 "+M(l(r).total)+" 个任务， "+M(l(r).activeCount)+" 个启用， "+M(l(r).errorCount)+" 个错误 ",1)]),_:1})]),_:1})]),_:1})]),_:1},8,["show"]),n(l(Me),{show:f.value,"onUpdate:show":t[11]||(t[11]=u=>f.value=u),title:h.value==="add"?"添加任务":"编辑任务",preset:"card",style:{width:"600px"},"mask-closable":!1},{footer:a(()=>[n(l(_),{justify:"end"},{default:a(()=>[n(l(b),{onClick:t[10]||(t[10]=u=>f.value=!1)},{default:a(()=>[...t[19]||(t[19]=[T("取消",-1)])]),_:1}),n(l(b),{type:"primary",onClick:re,loading:l(r).loading},{default:a(()=>[T(M(h.value==="add"?"添加":"保存"),1)]),_:1},8,["loading"])]),_:1})]),default:a(()=>[n(l(je),{ref_key:"formRef",ref:x,model:s.value,rules:Y,"label-placement":"left","label-width":"100","require-mark-placement":"right-hanging"},{default:a(()=>[n(l(z),{label:"任务名称",path:"name"},{default:a(()=>[n(l(j),{value:s.value.name,"onUpdate:value":t[2]||(t[2]=u=>s.value.name=u),placeholder:"请输入任务名称"},null,8,["value"])]),_:1}),n(l(z),{label:"网页URL",path:"url"},{default:a(()=>[n(l(j),{value:s.value.url,"onUpdate:value":t[3]||(t[3]=u=>s.value.url=u),placeholder:"https://example.com"},null,8,["value"])]),_:1}),n(l(z),{label:"任务描述",path:"description"},{default:a(()=>[n(l(j),{value:s.value.description,"onUpdate:value":t[4]||(t[4]=u=>s.value.description=u),type:"textarea",placeholder:"任务描述，用于AI分析时的上下文",rows:2},null,8,["value"])]),_:1}),n(l(z),{label:"CSS选择器",path:"selectors"},{default:a(()=>[n(l(j),{value:s.value.selectors,"onUpdate:value":t[5]||(t[5]=u=>s.value.selectors=u),placeholder:"多个选择器用逗号分隔，如: .content, #main"},null,8,["value"])]),_:1}),n(l(z),{label:"检测间隔",path:"interval"},{default:a(()=>[n(l(E),{value:s.value.interval,"onUpdate:value":t[6]||(t[6]=u=>s.value.interval=u),min:10,max:86400,style:{width:"100%"}},{suffix:a(()=>[...t[16]||(t[16]=[T("秒",-1)])]),_:1},8,["value"])]),_:1}),n(l(z),{label:"超时时间",path:"timeout"},{default:a(()=>[n(l(E),{value:s.value.timeout,"onUpdate:value":t[7]||(t[7]=u=>s.value.timeout=u),min:1e3,max:12e4,step:1e3,style:{width:"100%"}},{suffix:a(()=>[...t[17]||(t[17]=[T("毫秒",-1)])]),_:1},8,["value"])]),_:1}),n(l(z),{label:"启用状态"},{default:a(()=>[n(l(Be),{value:s.value.enabled,"onUpdate:value":t[8]||(t[8]=u=>s.value.enabled=u)},null,8,["value"])]),_:1}),n(l(Se),{style:{margin:"16px 0"}},{default:a(()=>[...t[18]||(t[18]=[T("AI 配置",-1)])]),_:1}),n(l(z),{label:"自定义提示词",path:"ai_prompt"},{default:a(()=>[n(l(j),{value:s.value.ai_prompt,"onUpdate:value":t[9]||(t[9]=u=>s.value.ai_prompt=u),type:"textarea",placeholder:ot,rows:3},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])]))}}),ft=Te(at,[["__scopeId","data-v-a03a2fc6"]]);export{ft as default};
